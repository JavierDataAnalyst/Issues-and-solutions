SELECT
		 s."NTP Date" AS "NTP Date Sunnova",
		 s."Contract Stage Date" as "Contract Stage Date",
		 s."sunnova_system_id" as "sunnova_system_id",
		 s."sunnova_stage" as "sunnova_stage",
		 s."Substantial Stage Date" as "substantial stage date",
		 s."Final Stage Date" as "final stage date",
		 s."Duration Since Contract" as "duration since contract",
		 s."Duration Hold Back" as "duration hold back",
		 s."Completion Stage Date" as completion_stage_date,
		 s."Asset Portfolio" as "Asset Portfolio",
		 s."System Project Status" as "System Project Status",
		 s."Contract Type" as "Contract Type",
		 s."Commissioning Package" as "Commissioning Package Sunnova",
		 n."Ready to Review" AS "Ready to Review",
		 n."Complete" AS "Complete",
		 n."Finance Incomplete" AS "Finance Incomplete",
		 n."Construction & Finance Incomplete" AS "Construction & Finance Incomplete",
		 n."Construction Incomplete" AS "Construction Incomplete",
		 n."Complete (Days)" as "Complete (Days)",
		 n."Finance Incomplete (Days)" as "Finance Incomplete (Days)",
		 n."Ready to Review (Days)" as "Ready to Review (Days)",
		 n."Construction & Finance Incomplete (Days)" as "Construction & Finance Incomplete (Days)",
		 n."Construction Incomplete (Days)" as "Construction Incomplete (Days)",
		 n."Date All Sales Docs Received" as "Date All Sales Docs Received",
		 
			CASE
				 WHEN n."Date All Sales Docs Received"  IS NOT NULL
				 AND	d."Closing Date"  IS NOT NULL
				 AND	n."Date All Sales Docs Received"  < d."Closing Date" then date_diff(n."Date All Sales Docs Received", d."Deal Created Time")
				 WHEN n."Date All Sales Docs Received"  IS NOT NULL
				 AND	d."Closing Date"  IS NOT NULL
				 AND	n."Date All Sales Docs Received"  >= d."Closing Date" then date_diff(n."Date All Sales Docs Received", d."Closing Date")
				 ELSE Null
			 END as "Closing - Docs Received",
		 
			CASE
				 WHEN n."Date All Sales Docs Received"  IS NOT NULL
				 AND	d."Closing Date"  IS NOT NULL THEN 
					CASE
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 0
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 1 THEN '0 a 1'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 1
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 2 THEN '1 a 2'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 2
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 3 THEN '2 a 3'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 3
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 4 THEN '3 a 4'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 4
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 5 THEN '4 a 5'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 5
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 6 THEN '5 a 6'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 6
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 7 THEN '6 a 7'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 7
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 8 THEN '7 a 8'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 8
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 9 THEN '8 a 9'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 9
						 AND	date_diff(n."Date All Sales Docs Received", d."Closing Date")  < 10 THEN '9 a 10'
						 WHEN date_diff(n."Date All Sales Docs Received", d."Closing Date")  >= 10 THEN 'más de 10'
						 ELSE NULL
					 END
				 ELSE NULL
			 END AS "Closing - Docs Received Range",
		 
			CASE
				 WHEN d."Closing Date"  IS NOT NULL
				 AND	d."Deal Stage"  like '%NTP%'
				 AND	n."Date All Sales Docs Received"  IS NULL THEN date_diff(current_date(), d."Closing Date")
				 ELSE Null
			 END as "Follow cases no docs",
		 
			CASE
				 WHEN d."Closing Date"  IS NOT NULL
				 AND	d."Deal Stage"  like '%NTP%'
				 AND	n."Date All Sales Docs Received"  IS NULL THEN d."Name"
				 ELSE Null
			 END as "No docs",
		 d."Where" AS "Side",
		 d."Name" AS "Deal Name",
		 d."Deal Number" as "Deal Number",
		 d."Pipeline" as "Pipeline",
		 d."Full Name" as "Full Name",
		 d."Email" as "Email",
		 d."Phone" as "Phone",
		 d."Closing Date" AS "Closing Date",
		 d."Amount" AS "amount",
		 d."Installation Completed Date" AS "Installation Completed Date",
		 d."isDeal" as "IsDeal",
		 d."Installation time" AS "Installation Time",
		 DATEDIFF(d."Installation Completed Date", d."Closing Date") AS "Days Difference",
		 
			CASE
				 WHEN DATEDIFF(d."Installation Completed Date", d."Closing Date")  BETWEEN ( 				SELECT AVG(DATEDIFF(d1."Installation Completed Date", d1."Closing Date"))
				FROM  "Lead Data - Miguel" d1 
				WHERE	 d1."Closing Date"  IS NOT NULL
				 AND	d1."Installation Completed Date"  IS NOT NULL
 ) - 3 * ( 				SELECT STDDEV(DATEDIFF(d2."Installation Completed Date", d2."Closing Date"))
				FROM  "Lead Data - Miguel" d2 
				WHERE	 d2."Closing Date"  IS NOT NULL
				 AND	d2."Installation Completed Date"  IS NOT NULL
 )  AND  ( 				SELECT AVG(DATEDIFF(d1."Installation Completed Date", d1."Closing Date"))
				FROM  "Lead Data - Miguel" d1 
				WHERE	 d1."Closing Date"  IS NOT NULL
				 AND	d1."Installation Completed Date"  IS NOT NULL
 ) + 3 * ( 				SELECT STDDEV(DATEDIFF(d2."Installation Completed Date", d2."Closing Date"))
				FROM  "Lead Data - Miguel" d2 
				WHERE	 d2."Closing Date"  IS NOT NULL
				 AND	d2."Installation Completed Date"  IS NOT NULL
 ) THEN 'Normal'
				 ELSE 'Anómalo'
			 END AS "Anomaly Classification",
		 d."isCancelled" AS "Canceled",
		 d."Sales Consultant" AS "Sales Consultant",
		 d."Role" as "Consultant Role",
		 d."Sales Director" AS "Sales Director",
		 d."Channel" AS "Channel",
		 d."Inactive" AS "Inactive",
		 CONCAT('https://crm.zoho.com/crm/org666151142/tab/Potentials/', d."Deal Id") AS "Deal Link",
		 CONCAT('https://crm.zoho.com/crm/org666151142/tab/CustomModule9/', e.Id) AS "Engineering Record Link",
		 d."System Size (kW)" AS "System Size (kW)",
		 d."Products" as "Products",
		 ii."Battery Quantity" as "Battery Quantity",
		 ii."Installation Stage" as "Installation Stage",
		 ii."Installation Start Date" as "Installation Start Date",
		 p."Created Time PE" as "Created Time PE",
		 p."Scheduled Visit 1" as "Scheduled Visit 1",
		 p."Tier 2 Insurance Status" AS "Tier 2 Insurance Status",
		 p."Tier 2 Insurance Cost" AS "Tier 2 Insurance Cost",
		 p."Insurance Agency" AS "Insurance Agency",
		 p."Insurance Provided" AS "Insurance Provided",
		 p."Tier 2 Insurance Required" AS "Tier 2 Insurance Required",
		 
			CASE
				 WHEN d."System Size (kW)"  >= 11.75
				 OR	p."Tier 2 Insurance Required"  = 'Yes' THEN 'Yes'
				 ELSE 'No'
			 END AS "Insurance Required?",
		 p."Date Proof of Insurance Received" AS "Date Proof of Insurance Received",
		 
			CASE
				 WHEN p."Date Proof of Insurance Received"  IS NULL THEN 0
				 ELSE 1
			 END AS "C-DP-IR",
		 p."Date Proof of Insurance Requested" AS "Date Proof of Insurance Requested",
		 p."Scheduled" as "Scheduled",
		 p."Site Visit Complete - Need DR" as "Site Visit Complete - Need DR",
		 p."Site Survey Confirmed Date" as "Site Survey Confirmed Date",
		 p."Permit/POA Date Received" as "Permit/POA Date Received",
		 p."preliminary Design complete" as "preliminary Design complete",
		 p."Site Survey Completed Date" as "Site Survey Completed Date",
		 n."NTP Stage" AS "NTP Stage",
		 n."Finance NTP Requirements" AS "Finance NTP Requirements",
		 n."Construction NTP Requirements" AS "Construction NTP Requirements",
		 n."Modified Time" AS "NTP Modified Time",
		 n."Construction NTP Date" AS "Construction NTP Date",
		 d."Pre-Engineering  To" as "Pre-Engineering To",
		 d."Pre-Engineering  From" as "Pre-Engineering From",
		 d."NTP From" AS "NTP From",
		 d."NTP To" AS "NTP To",
		 Act2."Account Name" AS "Sales Org Name",
		 d."Deal Stage" AS "Deal Stage",
		 qd."Previous Stage to Closed Lost" as "Previous Stage to Closed Lost",
		 d."Owner" AS "Deal Owner Name",
		 d."Engineering" AS "Engineering",
		 e."Engineering Company" AS "Engineering Company",
		 Act1."Account Name" AS "Engineering Company Name",
		 d."Client Coordinator" AS "Client Coordinator",
		 d."Engineering From" AS "Engineering From",
		 d."Permit To" AS "Permit To Date",
		 d."Permit From" AS "Permit From Date",
		 d."Permit Received Date" AS "Permit Received Date",
		 d."Engineering To" AS "Engineering To",
		 d."Sub-category" AS "Sub_category",
		 IF(d."Engineering From"  IS NULL, DATEDIFF(CURRENT_DATE(), d."Engineering To"), NULL) AS "Open Engineering Current Time In Process",
		 IF(d."Engineering From"  IS NOT NULL, DATEDIFF(d."Engineering From", d."Engineering To"), NULL) AS "Closed Engineering Time In Process",
		 d."Sales Organization" AS "Sales Organization",
		 d."Type" AS "Deal Type",
		 d.finance_choice as finance_choice,
		 pp."Final Inspection Approved Date" as final_inspection_approved_date,
		 n."Sales Admin" AS "Sales Coordinator",
		 n."HOA Form Submitted Date" AS "HOA Form Submitted Date",
		 n."HOA Approval Received Date" AS "HOA Approval Received Date",
		 n."HOA Stage" AS "HOA Stage",
		 n."Date and Time Sent to Client for Approval" as "Date and Time Sent to Client for Approval",
		 n."Date and Time Customer Signed Design" AS "Date and Time Customer Signed Design",
		 e."Revision Start Date" AS "Revision Start Date",
		 e."Revision Complete Date" AS "Revision Complete Date",
		 e."Plans by" AS "Plans by",
		 e."Plan Start Date" AS "Plan Start Date",
		 e."Plan Complete Date" AS "Plan Complete Date",
		 e."QA Approved" AS "QA Approved",
		 e."QA Engineer" AS "QA Engineer",
		 e."Complete - Printed and Mailed" AS "Complete - Printed and Mailed",
		 e."Engineering Stage" AS "Engineering Stage",
		 e."Engineering QA Approved Date" AS "Engineering QA Approved Date",
		 e."Complete - Digital Plans Uploaded" AS "Complete - Digital Plans Uploaded",
		 e."QA Ready" AS "QA Ready",
		 pe."Permit Submitted Date" AS "Permit Submitted Date",
		 pe."Permit Delivered to Field Ops" AS "Permit Delivered to Field Ops",
		 pe."Revision Required by Building Department" AS "Revision Required by Building Department",
		 pe."Permit Approved Ready for Pickup" AS "Permit Approved Ready for Pickup",
		 pe."Engineering Complete - Ready for 1st Submittal" as "Engineering Complete - Ready for 1st Submittal",
		 pe."In Review with Building Department" as "In Review with Building Department",
		 pe."Revision Submitted Date" as revision_submitted_date,
		 pe."Revision Received Date" as revision_received_date,
		 pe."Permit Processing Stage" as "Permit Processing Stage",
		 pe."NOC Stage" as "NOC Stage",
		 pe.ahj_timeline as ahj_timeline,
		 pe.ahj_name as ahj_name,
		 pe.ahj_region as ahj_region,
		 pe.permit_tech as permit_tech,
		 pp."Commission Package Submitted from Sunnova" as "Commission Package Submitted from Sunnova",
		 f."Primary First Payment NTP Invoice Date" as primary_first_pay_ntp_invoice_date,
		 f."Primary First Payment Received Date" as primary_first_pay_received_date,
		 f."Primary First Payment Amount" as primary_first_pay_amount,
		 f."Primary Second Payment Substantial Invoice Date" as primary_second_pay_substantial_invoice_date,
		 f."Primary Second Payment Received Date" as primary_second_pay_received_date,
		 f."Primary Second Payment Amount" as primary_second_pay_amount,
		 f."Primary Third Payment Final Invoice Date" as primary_third_pay_final_invoice_date,
		 f."Primary Third Payment Received Date" as primary_thrid_pay_received_date,
		 f."Primary Third Payment Amount" as primary_third_pay_amount,
		 f."Financing Net EPC Amount" as financing_net_epc_amount,
		 u."PTO Approval Date" as "PTO Approval Date",
		 d."Utility To" as utility_to,
		 
			case
				 When pe."Revision Submitted Date"  is not null
				 AND	pe."Revision Received Date"  is not null then date_diff(pe."Revision Received Date", pe."Revision Submitted Date")
			 end as "Revision Time",
		 IF(d."Closing Date"  is not null, datediff(getdate(), d."Closing Date"), 0) as days_from_deal,
		 IF(d."Permit From"  IS Null, Datediff(getdate(), d."Permit To"), 0) AS 'Open Permit Current Time In Process',
		 IF(d."Permit From"  IS Not Null, Datediff(d."Permit From", d."Permit To"), 0) AS 'Closed Permit Time In Process',
		 IF(pe."Permit Submitted Date"  IS Null, Datediff(getdate(), d."Permit To"), 0) AS 'In Permit Stage But Not Submitted - Time In Process',
		 IF(pe."Permit Submitted Date"  IS Not Null, Datediff(pe."Permit Submitted Date", d."Permit To"), 0) AS 'How Long from Permit Stage to Submittal',
		 IF(e."Revision Complete Date"  IS NULL, DATEDIFF(CURRENT_DATE(), e."Revision Start Date"), '') AS "Open Revision Current Time In Process",
		 IF(e."Revision Complete Date"  IS NOT NULL, DATEDIFF(e."Revision Complete Date", e."Revision Start Date"), 0) AS "Closed Revision Time In Process",
		 u."PTO Approved Need Letter" as "PTO Approved Need Letter",
		 
			CASE
				 WHEN e."Revision Start Date"  IS NOT NULL
				 AND	(e."Revision Start Date"  >= d."Permit To") THEN 'Revision After Permit Stage'
				 WHEN e."Revision Start Date"  IS NOT NULL
				 AND	(e."Revision Start Date"  < d."Permit To") THEN 'Revision Before Permit Stage'
				 ELSE ''
			 END AS "Revision",
		 
			case
				 when d."Closing Date"  is not null
				 AND	d."NTP From"  is not null then date_diff(d."NTP From", d."Closing Date")
				 else null
			 end as "Days to NTP",
		 
			case
				 when s."NTP Date"  is not null
				 AND	s."Contract Stage Date"  is not null then date_diff(s."NTP Date", s."Contract Stage Date")
				 else null
			 end as "Contract & PMT Time",
		 
			case
				 when s."NTP Date"  is not null
				 AND	d."Closing Date"  is not null then date_diff(s."NTP Date", d."Closing Date")
				 else null
			 end as "Closing to Contract Validation",
		 
			case
				 when p."Created Time PE"  is not null
				 AND	d."Closing Date"  is not null then date_diff(p."Created Time PE", d."Closing Date")
				 else null
			 end as "Welcome Call Time",
		 
			case
				 when p."Created Time PE"  is not null
				 AND	p."Scheduled"  is not null then date_diff(p."Scheduled", p."Created Time PE")
				 else null
			 end as "Scheduled Time",
		 
			case
				 when p."Site Survey Completed Date"  is not null
				 AND	p."Scheduled"  is not null then date_diff(p."Site Survey Completed Date", p."Scheduled")
				 else null
			 end as "Site Visit Time",
		 
			case
				 when p."Permit/POA Date Received"  is not null
				 AND	p."Site Survey Confirmed Date"  is not null then date_diff(p."Permit/POA Date Received", p."Site Survey Confirmed Date")
				 else null
			 end as "POA/NOC Time",
		 
			case
				 when p."Site Survey Completed Date"  is not null
				 AND	p."preliminary Design complete"  is not null then date_diff(p."preliminary Design complete", p."Site Survey Completed Date")
				 else null
			 end as "FDA Creation",
		 
			case
				 when p."preliminary Design complete"  is not null
				 AND	n."Date and Time Customer Signed Design"  is not null then date_diff(n."Date and Time Customer Signed Design", p."preliminary Design complete")
				 else null
			 end as "FDA Confirmation",
		 
			case
				 when n."Date and Time Sent to Client for Approval"  is not null
				 AND	n."Date and Time Customer Signed Design"  is not null then date_diff(n."Date and Time Customer Signed Design", n."Date and Time Sent to Client for Approval")
				 else null
			 end as "Design Sent to Approval Time",
		 
			case
				 when n."Customer Change Order Sent Date"  is not null
				 AND	n."Change Order Completed Date"  is not null then date_diff(n."Change Order Completed Date", n."Customer Change Order Sent Date")
				 else null
			 end as "Change Order Sent to Completion Time",
		 
			case
				 when n."HOA Form Submitted Date"  is not null
				 AND	n."Date and Time Customer Signed Design"  is not null then date_diff(n."HOA Form Submitted Date", n."Date and Time Customer Signed Design")
				 else null
			 end as "Complete HOA Application",
		 
			case
				 when n."HOA Form Submitted Date"  is not null
				 AND	n."HOA Approval Received Date"  is not null then date_diff(n."HOA Approval Received Date", n."HOA Form Submitted Date")
				 else null
			 end as "HOA Submission/Review",
		 
			case
				 when n."Date and Time Customer Signed Design"  is not null
				 AND	p."Date Proof of Insurance Received"  is not null then date_diff(p."Date Proof of Insurance Received", n."Date and Time Customer Signed Design")
				 else null
			 end as "Tier 2 introduction",
		 
			case
				 when n."Tier 2 Insurance Required"  = 'Yes'
				 AND	p."Date Proof of Insurance Received"  is not null
				 AND	n."Construction NTP Date"  is not null then date_diff(n."Construction NTP Date", p."Date Proof of Insurance Received")
				 else null
			 end as "Tier 2 insurance",
		 
			case
				 When n."Ready to Review"  is not null
				 AND	n."Construction NTP Date"  is not null then date_diff(n."Construction NTP Date", n."Ready to Review")
			 end as "NTP Review - Documents consolidation",
		 
			case
				 WHEN e."Plan Complete Date"  IS NOT NULL
				 AND	e."Plan Start Date"  IS NOT NULL THEN date_diff(e."Plan Complete Date", e."Plan Start Date")
				 ELSE NULL
			 END AS engineering_plans,
		 
			case
				 WHEN e."Engineering QA Approved Date"  IS NOT NULL
				 AND	e."QA Ready"  IS NOT NULL THEN date_diff(e."Engineering QA Approved Date", e."QA Ready")
				 ELSE NULL
			 END AS Engineering_QA_review,
		 
			case
				 WHEN e."Complete - Digital Plans Uploaded"  IS NOT NULL
				 AND	e."Engineering QA Approved Date"  IS NOT NULL THEN date_diff(e."Complete - Digital Plans Uploaded", e."Engineering QA Approved Date")
				 ELSE NULL
			 END AS plans_stamped,
		 
			case
				 When pe."Permit Submitted Date"  is not null
				 AND	pe."Permit Received Date"  is not null then date_diff(pe."Permit Received Date", pe."Permit Submitted Date")
			 end as "Permit Application - Permit Received",
		 
			case
				 when pe."Permit Submitted Date"  is not null
				 AND	pe."Engineering Complete - Ready for Permitting"  is not null then date_diff(pe."Engineering Complete - Ready for Permitting", pe."Permit Submitted Date")
			 end as "Engineering to Review Time",
		 
			case
				 When pe."Permit Received Date"  is not null
				 AND	ii."Scheduled"  is not null then date_diff(ii."Scheduled", pe."Permit Received Date")
			 end as "Scheduled Installation",
		 
			case
				 When ii."Installation Completed Date"  is not null
				 AND	ii."Installation Confirmed Date"  is not null then date_diff(ii."Installation Completed Date", ii."Installation Confirmed Date")
			 end as "Installation",
		 
			case
				 When pp."Final Inspection Approved Date"  is not null
				 AND	ii."Installation Completed Date"  is not null then date_diff(ii."Installation Completed Date", pp."Final Inspection Approved Date")
			 end as "Inspection - Remote",
		 
			case
				 When ii."Installation Completed Date"  is not null
				 AND	pp."Post Install QA Completed Date"  is not null then date_diff(pp."Post Install QA Completed Date", ii."Installation Completed Date")
			 end as "Post-Install QA Review",
		 
			case
				 When f."Final Design and Assessment Submitted"  is not null
				 AND	pp."Post Install QA Completed Date"  is not null then date_diff(pp."Post Install QA Completed Date", f."Final Design and Assessment Submitted")
			 end as "FDA Submitted",
		 
			case
				 When pp."Commission Package Submitted from Sunnova"  is not null
				 AND	pp."Post Install QA Completed Date"  is not null then date_diff(pp."Commission Package Submitted from Sunnova", pp."Post Install QA Completed Date")
			 end as "Commissioning Package",
		 
			case
				 When u."Ready for Application Submittal"  is not null
				 AND	u."Application Submitted"  is not null then date_diff(u."Application Submitted", u."Ready for Application Submittal")
			 end as "PTO Application",
		 
			case
				 When u."Application in review"  is not null
				 AND	u."Application Submitted"  is not null then date_diff(u."Application in review", u."Application Submitted")
			 end as "PTO Application Submission and in review by Utility",
		 
			case
				 When u."Application in review"  is not null
				 AND	u."PTO Approved Need Letter"  is not null then date_diff(u."PTO Approved Need Letter", u."Application in review")
			 end as "PTO Received",
		 
			case
				 When u."System On"  is not null
				 AND	u."PTO Approval Date"  is not null then date_diff(u."System On", u."PTO Approval Date")
			 end as "Welcome to Service",
		 d."In Service to" as in_service_to,
		 d."In Service from" as in_service_from,
		 d."In service complete to" AS "In_service_complete_to"
FROM  "Lead Data - Miguel" d
LEFT JOIN(	SELECT
			 eg.Id AS "Id",
			 eg."Engineering Company" AS "Engineering Company",
			 eg."Associated Deal" AS "Associated Deal",
			 eg."Engineering QA Approved Date" AS "Engineering QA Approved Date",
			 es."QA Approved" AS "QA Approved",
			 eg."Revision Start Date" AS "Revision Start Date",
			 eg."Revision Complete Date" AS "Revision Complete Date",
			 eg."Plans by" AS "Plans by",
			 eg."QA Engineer" AS "QA Engineer",
			 eg."Plan Start Date" AS "Plan Start Date",
			 eg."Plan Complete Date" AS "Plan Complete Date",
			 es."Complete - Printed and Mailed" AS "Complete - Printed and Mailed",
			 eg."Engineering Stage" AS "Engineering Stage",
			 es."Complete - Digital Plans Uploaded" AS "Complete - Digital Plans Uploaded",
			 es."QA Ready" AS "QA Ready",
			 ROW_NUMBER() OVER(PARTITION BY eg."Associated Deal"  ORDER BY eg."Modified Time" DESC ) as rw
	FROM  "Engineering" eg
LEFT JOIN "Engineering Status" es ON eg.Id  = es."Engineering Stage History"  
) e ON d."Deal Id"  = e."Associated Deal"
	 AND	e.rw  = 1 
LEFT JOIN(	SELECT
			 "NTP Stage",
			 "Finance NTP Requirements",
			 "Construction NTP Requirements",
			 "Modified Time",
			 "Sales Admin",
			 "HOA Form Submitted Date",
			 "HOA Approval Received Date",
			 "HOA Stage",
			 "Date and Time Customer Signed Design",
			 "Date and Time Sent to Client for Approval",
			 "Associated Deal",
			 nh."Complete" AS "Complete",
			 nh."Complete (Days)" as "Complete (Days)",
			 nh."Finance Incomplete (Days)" as "Finance Incomplete (Days)",
			 nh."Ready to Review (Days)" as "Ready to Review (Days)",
			 nh."Construction & Finance Incomplete (Days)" as "Construction & Finance Incomplete (Days)",
			 nh."Construction Incomplete (Days)" as "Construction Incomplete (Days)",
			 nh."Finance Incomplete" AS "Finance Incomplete",
			 nh."Ready to Review" AS "Ready to Review",
			 nh."Construction & Finance Incomplete" AS "Construction & Finance Incomplete",
			 nh."Construction Incomplete" AS "Construction Incomplete",
			 "Construction NTP Date" AS "Construction NTP Date",
			 "Date Insurance Received",
			 "Tier 2 Insurance Required",
			 "Date All Sales Docs Received",
			 "Customer Change Order Sent Date",
			 "Change Order Completed Date",
			 ROW_NUMBER() OVER(PARTITION BY "Associated Deal"  ORDER BY "Modified Time" DESC ) AS Rw
	FROM  "NTP"
LEFT JOIN "NTP History" nh ON NTP.Id  = nh."NTP Stage History"  
) n ON d."Deal Id"  = n."Associated Deal"
	 AND	n.Rw  = 1 
LEFT JOIN(	SELECT
			 p1."Created Time" as "Created Time PE",
			 p1."Scheduled Visit 1" as "Scheduled Visit 1",
			 p1."Associated Deal" as "Associated Deal",
			 p1."Tier 2 Insurance Status" AS "Tier 2 Insurance Status",
			 p1."Tier 2 Insurance Cost" AS "Tier 2 Insurance Cost",
			 p1."Insurance Agency" AS "Insurance Agency",
			 p1."Insurance provided" AS "Insurance Provided",
			 p1."Tier 2 Insurance Required" AS "Tier 2 Insurance Required",
			 p1."Preliminary Design Complete" AS "preliminary Design complete",
			 p1."Date Proof of Insurance Received" AS "Date Proof of Insurance Received",
			 p1."Date Proof of Insurance Requested" AS "Date Proof of Insurance Requested",
			 p1."Site Survey Confirmed Date" as "Site Survey Confirmed Date",
			 p1."Permit/POA Date Received" as "Permit/POA Date Received",
			 p1."Site Survey Completed Date" as "Site Survey Completed Date",
			 p2."Site Visit Complete - Need DR" as "Site Visit Complete - Need DR",
			 p2."SS & DR Completed" as "SS & DR Completed",
			 p2."Scheduled" as "Scheduled",
			 ROW_NUMBER() OVER(PARTITION BY p1."Associated Deal"  ORDER BY p1."Modified Time" DESC ) AS rrw
	FROM  "Pre-Engineering" p1
LEFT JOIN "Pre-Engineering History" p2 ON p1.Id  = p2."Site Survey Record"  
) p ON d."Deal Id"  = p."Associated Deal"
	 AND	p.rrw  = 1 
LEFT JOIN(	SELECT
			 Permit.Id AS id,
			 "Permit Submitted Date",
			 "Associated Deal",
			 "Permit Processing Stage",
			 "NOC Stage",
			 ps."Permit Delivered to Field Ops" AS "Permit Delivered to Field Ops",
			 ps."Revision Required by Building Department" AS "Revision Required by Building Department",
			 ps."Permit Approved Ready for Pickup" AS "Permit Approved Ready for Pickup",
			 ps."Engineering Complete - Ready for Permitting" AS "Engineering Complete - Ready for Permitting",
			 "Permit Received Date",
			 ps."Permit Delivered to Field Ops",
			 ps."Engineering Complete - Ready for 1st Submittal" as "Engineering Complete - Ready for 1st Submittal",
			 ps."In Review with Building Department" as "In Review with Building Department",
			 "Revision Submitted Date",
			 "Revision Received Date",
			 AHJ."AHJ Timeline" as ahj_timeline,
			 AHJ."AHJ Name" as ahj_name,
			 AHJ."AHJ Region" as ahj_region,
			 Users."Full Name" AS permit_tech,
			 ROW_NUMBER() OVER(PARTITION BY "Associated Deal"  ORDER BY Permit."Modified Time" DESC ) AS wr
	FROM  "Permit"
LEFT JOIN "Permit Status" ps ON Permit.Id  = ps."Permit Application Record" 
LEFT JOIN "AHJ" ON AHJ.Id  = Permit."AHJ" 
LEFT JOIN "Users" ON Permit."Assigned To"  = Users."Id"  
) pe ON pe."Associated Deal"  = d."Deal Id"
	 AND	pe.wr  = 1 
LEFT JOIN(	SELECT
			 sp."NTP Date" AS "NTP Date",
			 sp."Sunnova System Id" AS "sunnova_system_id",
			 sp."Stage" AS "sunnova_stage",
			 sp."Contract Stage Date" AS "Contract Stage Date",
			 sp."Related Deal" AS "Related Deal",
			 sp."Modified Time" AS "Modified Time",
			 sp."Substantial Stage Date" AS "Substantial Stage Date",
			 sp."Final Stage Date" AS "Final Stage Date",
			 sp."Duration Since Contract" AS "Duration Since Contract",
			 sp."Duration Hold Back" AS "Duration Hold Back",
			 sp."Completion Stage Date" AS "Completion Stage Date",
			 sp."Asset Portfolio" AS "Asset Portfolio",
			 sp."System Project Status" AS "System Project Status",
			 sp."Contract Type" AS "Contract Type",
			 sp."Commissioning Package" as "Commissioning Package",
			 ROW_NUMBER() OVER(PARTITION BY sp."Related Deal"  ORDER BY sp."Modified Time" DESC ) AS re
	FROM  "Sunnova Pipeline" sp 
) s ON s."Related Deal"  = d."Deal Id"
	 AND	s.re  = 1 
LEFT JOIN Accounts Act1 ON Act1.Id  = e."Engineering Company" 
LEFT JOIN Accounts Act2 ON Act2.Id  = d."Sales Organization" 
LEFT JOIN(	SELECT
			 i.Id as id,
			 i."Associated Deal" as "Associated deal",
			 ih."Scheduled" as "Scheduled",
			 ih."Complete" as "Complete",
			 i."Installation Stage" as "Installation Stage",
			 i."Installation Start Date" as "Installation Start Date",
			 i."Installation Confirmed Date" AS "Installation Confirmed Date",
			 i."Installation Completed Date" as "Installation Completed Date",
			 i."Battery Quantity" as "Battery Quantity",
			 ROW_NUMBER() OVER(PARTITION BY i."Associated Deal"  ORDER BY i."Modified Time" DESC ) AS e
	FROM  "Installation" i
LEFT JOIN "Installation History" ih ON i.Id  = ih."Installation Record"  
) ii ON ii."Associated deal"  = d."Deal Id"
	 AND	ii.e  = 1 
LEFT JOIN(	SELECT
			 pi.Id as id,
			 pi."Final Inspection Scheduled Date" as "Final Inspection Scheduled Date",
			 pi."Associated Deal" as "Associated Deal",
			 pi."Post Install QA Completed Date" as "Post Install QA Completed Date",
			 pi."Final Inspection Approved Date" AS "Final Inspection Approved Date",
			 pi."Commission Package Submitted from Sunnova" as "Commission Package Submitted from Sunnova",
			 ROW_NUMBER() OVER(PARTITION BY pi."Associated Deal"  ORDER BY pi."Modified Time" DESC ) AS rr
	FROM  "Post Installation" pi
LEFT JOIN "Post Installation History" poi ON pi.Id  = poi."Final Inspection Record"  
) pp ON pp."Associated Deal"  = d."Deal Id"
	 AND	pp.rr  = 1 
LEFT JOIN(	SELECT
			 "Final Design and Assessment Submitted",
			 "Commissioning Package Submitted",
			 "Associated Deal",
			 "Modified Time",
			 "Primary First Payment NTP Invoice Date",
			 "Primary First Payment Received Date",
			 "Primary First Payment Amount",
			 "Primary Second Payment Substantial Invoice Date",
			 "Primary Second Payment Received Date",
			 "Primary Second Payment Amount",
			 "Primary Third Payment Final Invoice Date",
			 "Primary Third Payment Received Date",
			 "Primary Third Payment Amount",
			 "Financing Net EPC Amount",
			 ROW_NUMBER() OVER(PARTITION BY "Associated Deal"  ORDER BY "Modified Time" DESC ) AS w
	FROM  "Financing" 
) f ON f."Associated Deal"  = d."Deal Id"
	 AND	f.w  = 1 
LEFT JOIN(	SELECT
			 uh."Ready for Application Submittal" as "Ready for Application Submittal",
			 uh."Application Submitted" as "Application Submitted",
			 "Associated Deal",
			 "PTO Approval Date",
			 uh."Application In Review" as "Application in review",
			 uh."PTO Approved Need Letter" as "PTO Approved Need Letter",
			 uh."System On" as "System On",
			 ROW_NUMBER() OVER(PARTITION BY "Associated Deal"  ORDER BY "Modified Time" DESC ) AS ur
	FROM  "Utility"
LEFT JOIN "Utility History" AS  uh ON "Utility".Id  = uh."Utility Record"  
) u ON u."Associated Deal"  = d."Deal Id"
	 AND	u.ur  = 1 
LEFT JOIN(	SELECT
			 "id",
			 MAX(CASE
					 WHEN "Stage"  = 'Closed Lost' THEN "Modified Time"
					 ELSE NULL
				 END) AS "Closed Lost Date",
			 MAX("Previous Stage to Closed") AS "Previous Stage to Closed Lost"
	FROM  "Q-Deal Stage History" 
	GROUP BY  "id" 
) qd ON qd.id  = d."Deal Id"  
